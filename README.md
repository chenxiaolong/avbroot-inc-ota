# avbroot-inc-ota

`avbroot-inc-ota` is a tool for converting between incremental and full Android A/B OTA zips. It can:

* generate a signed incremental OTA from two full OTAs
* apply an incremental OTA to a full OTA to produce a new full OTA

**NOTE**: This is a proof of concept, but has been tested on real devices and should work with any valid OTAs. Due to the dependency on AOSP's `delta_generator`, it will never be integrated into [avbroot](https://github.com/chenxiaolong/avbroot). Also, I only work on this project when there's something I find fun and interesting to do with it. Don't expect regular updates.

## Warning

In general, the key used to sign the output OTA should be the same one that was used to sign the input OTAs. Otherwise, the resulting OTA will not be very useful: even if it can be flashed, sideloading further updates will not work.

The main exception to this is when creating a new full OTA to feed into avbroot, for example, if an OEM only provides an old full OTA and more recent incremental OTAs.

## Building from source

1. Download the AOSP source code (or the source code for any AOSP-based OS). This will likely require 100-200 GiB of disk space.

2. Inside the AOSP source directory, build `delta_generator`.

    ```bash
    source build/envsetup.sh
    m delta_generator
    ```

    The output will be in `out/host/linux-x86/bin/delta_generator`.

3. Ensure the [Rust toolchain](https://www.rust-lang.org/) is installed.

4. Clone this git repo and build `avbroot-inc-ota`.

    ```bash
    cargo build --release
    ```

    The output will be in `target/release/avbroot-inc-ota`.

## Generate incremental OTA

To generate an incremental OTA from two full OTAs:

```bash
avbroot-inc-ota \
    generate \
    --input-old /path/to/old/full/ota.zip \
    --input-new /path/to/new/full/ota.zip \
    --output-inc /path/to/output/incremental/ota.zip \
    --delta-generator /path/to/aosp/out/host/linux-x86/bin/delta_generator \
    --key /path/to/ota.key \
    --cert /path/to/ota.crt
```

For testing, it is perfectly valid to use the same file as both the old and new full OTAs. The resulting incremental OTA will just "upgrade" to the same Android build.

## Apply incremental OTA

To apply an incremental OTA to a full OTA and produce a new full OTA:

```bash
avbroot-inc-ota \
    apply \
    --input-old /path/to/old/full/ota.zip \
    --input-inc /path/to/incremental/ota.zip \
    --output-new /path/to/output/full/ota.zip \
    --delta-generator /path/to/aosp/out/host/linux-x86/bin/delta_generator \
    --key /path/to/ota.key \
    --cert /path/to/ota.crt
```

## How it works

### Incremental OTA generation

The delta `payload.bin` is generated by AOSP's `delta_generator`. It computes the binary diff between old and new raw partition images and stores the resulting `bsdiff` diffs in an unsigned payload. Since bsdiff computation is slow, CPU/memory intensive, and produces large diffs when an unmodified block is moved to a different offset in the new image, `delta_generator` includes ext4 and erofs filesystem parsers to compare the data of individual files. This allows diff computation for blocks containing identical files to be avoided entirely and instead, stores `SOURCE_COPY` operations in the payload. (The necessity of these filesystem parsers is why this project won't be integrated into avbroot.)

`delta_generator` also requires a few additional input files:

* `apex_info.pb` - This is simply extracted from the new full OTA's zip.
* `dynamic_partitions_info.txt` - This is a `key=value` text file used in AOSP's `target_files` directory structure that stores information about the `super` partition and virtual A/B compression. Only a partial set of the keys can be generated from information contained in the new full OTA, but that subset is sufficient for running `delta_generator`. This information is ultimately stored in the incremental OTA's `payload.bin` header.
* `postinstall_config.txt` - This is another `key=value` text file used in AOSP's `target_files` directory structure that stores information about the postinstall scripts that run after the OTA is installed. This information can be completely generated from the new full OTA and is stored in the incremental OTA's `payload.bin` header.

The `META-INF/com/android/metadata{,.pb}` files are generated from the new full OTA, but with the `build` and `build-incremental` precondition fields set to the appropriate values from the old full OTA. This prevents the incremental OTA from being installed on top of an Android build that it wasn't built for.

### Incremental OTA application

AOSP's `delta_generator` supports taking two sets of raw partition image files (input and output) and then applying a delta `payload.bin` to produce the new images. It requires that the target image files already exist and that they have the correct size, though the contents do not matter. When applying a delta payload this way, virtual A/B is completely disabled, even if the input OTAs ask for it to be enabled. As a result, this process runs fully in userspace without needing to create any special block devices.

The `payload.bin` manifest and the `META-INF/com/android/metadata{,.pb}` OTA metadata are taken from the incremental OTA, with the incremental bits discarded (like the OS fingerprint precondition). For the payload manifest, to match the behavior of AOSP, the minor version is set to 0 and any fields that require a newer minor version are discarded. This avoids needing to copy the dm-verity hash tree and FEC information from the AVB 2.0 descriptors to the payload manifest.

For simplicity of implementation, every partition is extracted and recompressed, even if the incremental OTA does not modify it. There is no logic to directly copy compressed data from the original `payload.bin` (unlike avbroot).

## License

avbroot-inc-ota is licensed under GPLv3. Please see [`LICENSE`](./LICENSE) for the full license text.
